<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro HTML Editor - Fixed</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background:#0d1117;
  color:#c9d1d9;
  height:100vh;
  display:flex;
  overflow:hidden;
  font-family: 'Courier New', Courier, monospace;
}

/* Left Panel: Editors */
#left {
  width:40%;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  background:#161b22;
  border-right: 1px solid #30363d;
}

/* Right Panel: Preview & Console */
#right {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px;
  gap:10px;
  background:#0d1117;
}

.panel-title {
  margin-bottom:5px;
  font-weight: bold;
  font-size:14px;
  color: #58a6ff;
}

/* Editor Container Style */
.CodeMirror {
  height: 200px !important;
  border:1px solid #30363d;
  border-radius:6px;
  font-size: 14px;
}

/* Buttons */
.toolbar {
  display:flex;
  gap:8px;
  flex-wrap: wrap;
}

button {
  padding:8px 14px;
  border:0;
  cursor:pointer;
  border-radius:6px;
  font-size:13px;
  font-weight: bold;
  transition: opacity 0.2s;
}
button:hover { opacity: 0.9; }

.run-btn { background:#238636; color:white; }
.theme-btn { background:#21262d; color:#c9d1d9; border: 1px solid #30363d; }
.action-btn { background:#1f6feb; color:white; }

/* Preview Iframe */
#preview {
  flex:1;
  border-radius:6px;
  border:none;
  background:white;
}

/* Console */
#console {
  height:150px;
  background:#0d1117;
  border:1px solid #30363d;
  border-radius:6px;
  padding:10px;
  overflow:auto;
  font-family: monospace;
  font-size:12px;
  color: #fff;
}
.console-log { border-bottom: 1px solid #21262d; padding: 2px 0; }
.console-error { color: #ff7b72; }

/* AI Helper Box */
#ai-box {
  background:#161b22;
  padding:10px;
  border-radius:6px;
  border:1px solid #30363d;
  font-size:12px;
  color: #8b949e;
}
</style>
</head>
<body>

<div id="left">
    <div>
        <div class="panel-title">HTML</div>
        <textarea id="htmlCode"><h1>Hello World</h1>
<p>Welcome to Pro Editor.</p>
<button id="btn">Click Me</button></textarea>
    </div>

    <div>
        <div class="panel-title">CSS</div>
        <textarea id="cssCode">body {
  font-family: sans-serif;
  text-align: center;
  padding: 20px;
}
h1 { color: #e91e63; }
button {
  padding: 10px 20px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}</textarea>
    </div>

    <div>
        <div class="panel-title">JavaScript</div>
        <textarea id="jsCode">document.getElementById('btn').addEventListener('click', () => {
  alert('Button Clicked!');
  console.log('Action logged to custom console');
});</textarea>
    </div>

    <div>
        <div class="panel-title">ðŸ’¡ Tips</div>
        <div id="ai-box">
            - <b>Ctrl/Cmd + S</b> functionality is manual via Save button.<br>
            - Use <code>console.log()</code> to debug below.<br>
            - Click <b>RUN</b> to update the preview.
        </div>
    </div>
</div>

<div id="right">
    <div class="toolbar">
        <button class="run-btn" onclick="run()">â–¶ RUN</button>
        <button class="theme-btn" onclick="toggleTheme()">Theme</button>
        <button class="action-btn" onclick="saveProject()">Save</button>
        <button class="action-btn" onclick="loadProject()">Load</button>
        <button class="action-btn" onclick="downloadProject()">Download .html</button>
    </div>

    <iframe id="preview"></iframe>
    <div id="console"><strong>> Console Ready...</strong></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>

<script>
// --- Editor Setup ---
const editorConfig = { lineNumbers: true, theme: "dracula", tabSize: 2 };

const htmlEditor = CodeMirror.fromTextArea(document.getElementById("htmlCode"), { mode: "xml", ...editorConfig });
const cssEditor = CodeMirror.fromTextArea(document.getElementById("cssCode"), { mode: "css", ...editorConfig });
const jsEditor = CodeMirror.fromTextArea(document.getElementById("jsCode"), { mode: "javascript", ...editorConfig });

// --- Console Logic ---
function logToConsole(msg, isError = false) {
    const con = document.getElementById("console");
    const div = document.createElement("div");
    div.className = isError ? "console-log console-error" : "console-log";
    div.textContent = "> " + msg;
    con.appendChild(div);
    con.scrollTop = con.scrollHeight;
}

window.addEventListener("message", (event) => {
    if (event.data.type === "console") {
        logToConsole(event.data.message);
    } else if (event.data.type === "error") {
        logToConsole(event.data.message, true);
    }
});

// --- Run Function (FIXED) ---
function run() {
    const html = htmlEditor.getValue();
    const css = `<style>${cssEditor.getValue()}</style>`;
    
    // NOTE: We use <\/script> to avoid breaking the HTML parser
    const js = `
        <script>
        // Override console.log to send messages to parent
        const originalLog = console.log;
        console.log = function(...args) {
            // Convert objects to strings for better readability
            const msg = args.map(arg => 
                (typeof arg === 'object') ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            parent.postMessage({type:'console', message: msg}, '*');
            originalLog.apply(console, args);
        };

        // Catch global errors
        window.onerror = function(message, source, lineno, colno, error) {
            parent.postMessage({type:'error', message: message + ' (Line: ' + lineno + ')'}, '*');
        };

        try {
            ${jsEditor.getValue()}
        } catch(e) {
            console.log("Error: " + e.message);
        }
        <\/script>
    `;

    const iframe = document.getElementById("preview");
    const doc = iframe.contentWindow.document;

    // Clear console visually before run
    document.getElementById("console").innerHTML = "<strong>> Console Cleared...</strong>";

    doc.open();
    doc.write(html + css + js);
    doc.close();
}

// --- Theme Toggle ---
let isDark = true;
function toggleTheme() {
    isDark = !isDark;
    const theme = isDark ? "dracula" : "default";
    const bg = isDark ? "#0d1117" : "#f0f0f0";
    const color = isDark ? "#c9d1d9" : "#333";
    
    document.body.style.background = bg;
    document.body.style.color = color;
    document.getElementById("left").style.background = isDark ? "#161b22" : "#e0e0e0";
    
    htmlEditor.setOption("theme", theme);
    cssEditor.setOption("theme", theme);
    jsEditor.setOption("theme", theme);
}

// --- Storage Functions ---
function saveProject() {
    const data = {
        html: htmlEditor.getValue(),
        css: cssEditor.getValue(),
        js: jsEditor.getValue(),
    };
    localStorage.setItem("pro_editor_data", JSON.stringify(data));
    alert("Project Saved to LocalStorage!");
}

function loadProject() {
    const raw = localStorage.getItem("pro_editor_data");
    if (!raw) return alert("No saved project found!");
    
    const data = JSON.parse(raw);
    htmlEditor.setValue(data.html);
    cssEditor.setValue(data.css);
    jsEditor.setValue(data.js);
}

function downloadProject() {
    const code = `
<!DOCTYPE html>
<html>
<head><style>${cssEditor.getValue()}</style></head>
<body>
${htmlEditor.getValue()}
<script>${jsEditor.getValue()}<\/script>
</body>
</html>`;

    const blob = new Blob([code], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-project.html";
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
